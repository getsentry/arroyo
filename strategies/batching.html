<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Batch and Unbatch - Arroyo documentation</title><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Run Task" href="run_task.html" /><link rel="prev" title="Unfold" href="unfold.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=ad592e98" />
    <link rel="stylesheet" type="text/css" href="../_static/shibuya.css?v=d140fbf8" />
    <link media="print" rel="stylesheet" type="text/css" href="../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=d78f5285" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="Batch and Unbatch"/>
<meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../index.html">
      <img class="light-logo" src="../_static/arroyo-logo.png" alt="Arroyo" height="28" loading="lazy" />
      <img class="dark-logo" src="../_static/arroyo-logo.png" alt="Arroyo" height="28" loading="lazy" />
      <strong>Arroyo</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../what_for.html">What is Arroyo for?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getstarted.html">Getting started with Arroyo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">Arroyo Architecture</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Processing Strategies</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="filter.html">Filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="reduce.html">Reduce (Fold)</a></li>
<li class="toctree-l2"><a class="reference internal" href="unfold.html">Unfold</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Batch and Unbatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="run_task.html">Run Task</a></li>
<li class="toctree-l2"><a class="reference internal" href="run_task_in_threads.html">Run Task in Threads</a></li>
<li class="toctree-l2"><a class="reference internal" href="run_task_with_multiprocessing.html">Run Task with Multiprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="produce.html">Produce</a></li>
<li class="toctree-l2"><a class="reference internal" href="commit_offsets.html">Commit offsets</a></li>
<li class="toctree-l2"><a class="reference internal" href="noop.html">Noop</a></li>
<li class="toctree-l2"><a class="reference internal" href="healthcheck.html">Healthchecks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../offsets.html">Committing offsets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dlqs.html">Dead letter queues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backpressure.html">Backpressure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../metrics.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parameters.html">Common consumer parameters</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div class="localtoc"><h3>On this page</h3><ul>
<li><a class="reference internal" href="#arroyo.processing.strategies.batching.BatchStep"><code class="docutils literal notranslate"><span class="pre">BatchStep</span></code></a><ul>
<li><a class="reference internal" href="#arroyo.processing.strategies.batching.BatchStep.join"><code class="docutils literal notranslate">join()</span></code></a></li>
<li><a class="reference internal" href="#arroyo.processing.strategies.batching.BatchStep.submit"><code class="docutils literal notranslate">submit()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#arroyo.processing.strategies.batching.UnbatchStep"><code class="docutils literal notranslate"><span class="pre">UnbatchStep</span></code></a></li>
</ul>
</div><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Arroyo</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="index.html"><span itemprop="name">Processing Strategies</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">Batch and Unbatch</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <section id="batch-and-unbatch">
<h1>Batch and Unbatch<a class="headerlink" href="#batch-and-unbatch" title="Link to this heading">Â¶</a></h1>
<p>Accumulate messages into a batch and pass to the next step.
The batch and unbatch strategies are based on reduce and unfold.
Use reduce/unfold instead if you want to provide custom
accumulator/generator functions.</p>
<dl class="py class" id="module-arroyo.processing.strategies.batching">
<dt class="sig sig-object py" id="arroyo.processing.strategies.batching.BatchStep">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">arroyo.processing.strategies.batching.</span></span><span class="sig-name descname"><span class="pre">BatchStep</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">max_batch_size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_batch_time</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">next_step</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="index.html#arroyo.processing.strategies.abstract.ProcessingStrategy" title="arroyo.processing.strategies.abstract.ProcessingStrategy"><span class="pre">ProcessingStrategy</span></a><span class="p"><span class="pre">[</span></span><span class="pre">MutableSequence</span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="index.html#arroyo.types.BaseValue" title="arroyo.types.BaseValue"><span class="pre">BaseValue</span></a><span class="p"><span class="pre">[</span></span><span class="pre">TStrategyPayload</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">compute_batch_size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="index.html#arroyo.types.BaseValue" title="arroyo.types.BaseValue"><span class="pre">BaseValue</span></a><span class="p"><span class="pre">[</span></span><span class="pre">TStrategyPayload</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">int</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#arroyo.processing.strategies.batching.BatchStep" title="Link to this definition">Â¶</a></dt>
<dd><p>Accumulates messages into a batch. When the batch is full, this
strategy submits it to the next step.</p>
<p>A batch is represented as a <cite>ValuesBatch</cite> object which is a sequence
of BaseValue. This includes both the messages and the high offset
watermark.</p>
<p>A messages batch is closed and submitted when the maximum number of
messages is received or when the max_batch_time has passed since the
first message was received.</p>
<p>This step does not require in order processing. If messages are sent
out of order, though, the highest observed offset per partition is
still the committable one, whether or not all messages with lower
offsets have been observed by this step.</p>
<p>This strategy propagates <cite>MessageRejected</cite> exceptions from the
downstream steps if they are thrown.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>max_batch_size</strong> â How many messages should be reduced into one at maximum.</p></li>
<li><p><strong>max_batch_time</strong> â How much time (in seconds) should be spent reducing
messages together before flushing the batch.</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="arroyo.processing.strategies.batching.BatchStep.join">
<span class="sig-name descname"><span class="pre">join</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">timeout</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#arroyo.processing.strategies.batching.BatchStep.join" title="Link to this definition">Â¶</a></dt>
<dd><p>Terminates the strategy by joining the following step.
This method tries to flush the current batch no matter
whether the batch is ready or not.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="arroyo.processing.strategies.batching.BatchStep.submit">
<span class="sig-name descname"><span class="pre">submit</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">message</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="index.html#arroyo.types.Message" title="arroyo.types.Message"><span class="pre">Message</span></a><span class="p"><span class="pre">[</span></span><a class="reference internal" href="index.html#arroyo.types.FilteredPayload" title="arroyo.types.FilteredPayload"><span class="pre">FilteredPayload</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">TStrategyPayload</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#arroyo.processing.strategies.batching.BatchStep.submit" title="Link to this definition">Â¶</a></dt>
<dd><p>Accumulates messages in the current batch.
A new batch is created at the first message received.</p>
<p>This method tries to flush before adding the message
to the current batch. This is so that, if we receive
<cite>MessageRejected</cite> exception from the following step,
we can propagate the exception without processing the
new message. This allows the previous step to try again
without introducing duplications.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="arroyo.processing.strategies.batching.UnbatchStep">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">arroyo.processing.strategies.batching.</span></span><span class="sig-name descname"><span class="pre">UnbatchStep</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">next_step</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="index.html#arroyo.processing.strategies.abstract.ProcessingStrategy" title="arroyo.processing.strategies.abstract.ProcessingStrategy"><span class="pre">ProcessingStrategy</span></a><span class="p"><span class="pre">[</span></span><a class="reference internal" href="index.html#arroyo.types.FilteredPayload" title="arroyo.types.FilteredPayload"><span class="pre">FilteredPayload</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">TStrategyPayload</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#arroyo.processing.strategies.batching.UnbatchStep" title="Link to this definition">Â¶</a></dt>
<dd><p>This processing step receives batches and explodes them thus sending
the content to the next step message by message.</p>
<p>A batch is represented as a <cite>ValuesBatch</cite> object.</p>
<p>If this step receives a <cite>MessageRejected</cite> exception from the next
step it would keep the remaining messages and attempt to submit
them at the following call to <cite>poll</cite></p>
</dd></dl>

</section>

        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"><div class="navigation-prev">
    <a href="unfold.html">
      <i class="i-lucide chevron-left"></i>
      <div class="page-info">
        <span>Previous</span><div class="title">Unfold</div></div>
    </a>
  </div><div class="navigation-next">
    <a href="run_task.html">
      <div class="page-info">
        <span>Next</span>
        <div class="title">Run Task</div>
      </div>
      <i class="i-lucide chevron-right"></i>
    </a>
  </div></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2023, Sentry Team and Contributors</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/shibuya.js?v=9b0e4dde"></script>
      <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
      <script>mermaid.initialize({startOnLoad:true});</script></body>
</html>